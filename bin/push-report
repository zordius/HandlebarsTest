#!/bin/sh
echo "DEBUG ENV: ${TRAVIS_JOB_NUMBER} ${TRAVIS_BUILD_NUMBER} ..."

if [ "${TRAVIS_BUILD_NUMBER}.5" != "${TRAVIS_JOB_NUMBER}" ]; then
  echo "Only push documents 1 time... quit."
  exit 0
fi

# Set for all push in this script.
git config --global user.name "Travis-CI"
git config --global user.email "zordius@users.noreply.gihub.com"

php bin/hbreport R x x
curl -O http://dynalon.github.io/mdwiki/index.html
phantomjs --local-to-remote-url-access=true bin/save-features.js

sudo add-apt-repository -y ppa:danmbox/ppa
sudo apt-get update
sudo apt-get install pngquant

pngquant 32 features0.png
mv features0-fs8.png features.png
git checkout -b tmp
git add FEATURES.md
git add features.png
git commit -m "Auto commit generated feature list [ci skip]"
git push --quiet "https://${GHTK}@github.com/zordius/HandlebarsTest.git" tmp:master > /dev/null 2>&1

echo Master pushed OK, will generate document....

cd report
phantomjs --local-to-remote-url-access=true ../bin/save-chart.js index.html?`ls 20*.json |tail -n 1`
mkdir build
pngquant 32 chart.png
mv chart-fs8.png build/chart.png
cp index.html build
cp versions.html build
cp *.json build
rm build/20130110*
rm build/*xdebug.json
cd build
ls 20*.json > reports
ls versions*.json > versions
git init
git add .
git commit -m "Auto deployed to Github Pages from branch ${TRAVIS_BRANCH} @${TRAVIS_COMMIT} [ci skip]"
git push --force --quiet "https://${GHTK}@github.com/zordius/HandlebarsTest.git" master:gh-pages > /dev/null 2>&1
